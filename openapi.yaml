openapi: 3.0.3
info:
  title: ExecFlex API
  description: |
    ExecFlex API - Combined API Server for executive matching and voice interactions.
    
    This API handles both web-based operations (role posting, matching, introductions) 
    and voice/telephony features powered by Ai-dan, an AI voice agent.
    
    ## Features
    - Executive candidate matching
    - Role posting and management
    - Email introductions
    - Voice calls via Twilio (Ai-dan)
    
    ## Authentication
    Most endpoints require JWT authentication via Supabase Auth. Include the JWT token in the Authorization header:
    `Authorization: Bearer <supabase_jwt_token>`
    
    Twilio webhook endpoints (`/voice/*`) are public and called by Twilio (signature verification recommended for production).
  version: 1.0.0
  contact:
    name: ExecFlex API Support
    url: https://execflex.com

servers:
  - url: https://execflex-backend-1.onrender.com
    description: Production server (Render)
  - url: http://localhost:5001
    description: Local development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Matching
    description: Executive candidate matching
  - name: Roles
    description: Role posting and management
  - name: Introductions
    description: Email introductions between clients and candidates
  - name: Voice
    description: Voice/telephony features (Ai-dan) - Twilio webhooks

paths:
  /:
    get:
      tags:
        - Health
      summary: Health check
      description: Simple health check endpoint that returns 200 if the service is running
      operationId: rootHealth
      responses:
        '200':
          description: Service is healthy

  /match:
    post:
      tags:
        - Matching
      summary: Find best candidate match
      description: |
        Finds the best matching executive candidate based on role requirements.
        Uses a scoring algorithm considering industry, expertise, availability, location, and salary.
        
        **Requires authentication** - JWT token in Authorization header.
      operationId: findMatch
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MatchRequest'
            example:
              industry: "Fintech"
              expertise: "CFO"
              availability: "fractional"
              min_experience: 10
              max_salary: 150000
              location: "Ireland"
      responses:
        '200':
          description: Match found or not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  message:
                    type: string
                  match:
                    $ref: '#/components/schemas/Match'
                    nullable: true
                    description: Match details (best candidate) or null if no match
                  matches:
                    type: array
                    items:
                      $ref: '#/components/schemas/Match'
                    description: List of all matches (up to 5), sorted by score
              examples:
                match_found:
                  value:
                    ok: true
                    message: "We recommend John Smith: Experienced CFO with 15 years in Fintech"
                    match:
                      id: "cand-001"
                      name: "John Smith"
                      role: "CFO"
                      summary: "Experienced CFO with 15 years in Fintech"
                      location: "Ireland"
                      industries: ["Fintech", "SaaS"]
                      expertise: ["CFO", "Finance"]
                      availability: "fractional"
                      experience_years: 15
                      comp_expectation: 120000
                      highlights: ["Led Series B fundraising", "Built finance team from scratch"]
                      email: "john@example.com"
                no_match:
                  value:
                    ok: true
                    message: "No match found yet. We'll follow up with suggestions soon."
                    match: null
                    matches: []
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /post-role:
    post:
      tags:
        - Roles
      summary: Post a new executive role
      description: |
        Submit a new executive role posting to the platform.
        
        **Requires authentication** - JWT token in Authorization header. The authenticated user's ID will be used as the creator.
      operationId: postRole
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RolePostingRequest'
            example:
              role_title: "Chief Financial Officer"
              company_name: "Acme Corp"
              industry: "Fintech"
              role_description: "Leading financial strategy for Series B startup"
              experience_level: "Senior"
              commitment: "fractional"
              role_type: "CFO"
              is_remote: true
              location: "Ireland"
              budget_range: "€100k-€150k"
              contact_name: "Jane Doe"
              contact_email: "jane@acme.com"
              phone: "+353123456789"
      responses:
        '201':
          description: Role posted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  message:
                    type: string
                  role:
                    $ref: '#/components/schemas/RolePosting'
                    nullable: true
                    description: The created role posting record
              example:
                ok: true
                message: "Role posted successfully!"
                role:
                  id: "role-123"
                  role_title: "Chief Financial Officer"
                  company_name: "Acme Corp"
                  industry: "Fintech"
                  created_at: "2024-01-15T10:30:00Z"
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '400':
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /request-intro:
    post:
      tags:
        - Introductions
      summary: Request an email introduction
      description: |
        Creates a thread and interaction for an introduction request, then sends an email introduction.
        The authenticated user's ID is used as the requester.
        
        **Requires authentication** - JWT token in Authorization header.
      operationId: requestIntro
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IntroRequest'
            example:
              user_type: "client"
              requester_name: "Jane Doe"
              requester_email: "jane@acme.com"
              requester_company: "Acme Corp"
              match_id: "cand-001"
              notes: "Series B GTM help needed"
      responses:
        '200':
          description: Introduction request processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  thread_id:
                    type: string
                    description: ID of the created thread
                  interaction_id:
                    type: string
                    nullable: true
                    description: ID of the created interaction (if email sent)
                  email_sent:
                    type: boolean
                    description: Whether the introduction email was sent
                  status:
                    type: string
                    enum: [sent, pending]
                    description: Status of the introduction request
              example:
                ok: true
                thread_id: "thread-123"
                interaction_id: "interaction-456"
                email_sent: true
                status: "sent"
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '400':
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /voice/intro:
    post:
      tags:
        - Voice
      summary: Twilio webhook - Call start
      description: |
        Webhook endpoint called by Twilio when a voice call starts.
        This initiates the IVR flow with Ai-dan.
        **Note:** This is a webhook endpoint, typically called by Twilio, not directly by API clients.
      operationId: voiceIntro
      requestBody:
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                CallSid:
                  type: string
                  description: Twilio Call SID
      responses:
        '200':
          description: TwiML response for call handling
          content:
            application/xml:
              schema:
                type: string
                description: TwiML XML
        '503':
          description: Voice features not available
    get:
      tags:
        - Voice
      summary: Twilio webhook - Call start (GET)
      description: Alternative GET handler for Twilio webhook
      operationId: voiceIntroGet
      responses:
        '200':
          description: TwiML response
          content:
            application/xml:
              schema:
                type: string
        '503':
          description: Voice features not available

  /voice/capture:
    post:
      tags:
        - Voice
      summary: Twilio webhook - Speech capture
      description: |
        Webhook endpoint called by Twilio after gathering speech input during a call.
        Handles the conversation flow and state management for Ai-dan.
        **Note:** This is a webhook endpoint, typically called by Twilio, not directly by API clients.
      operationId: voiceCapture
      parameters:
        - name: step
          in: query
          description: Current conversation step
          schema:
            type: string
            enum: [user_type, name, role, industry, location, availability, confirm_intro, email]
          example: "name"
      requestBody:
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                CallSid:
                  type: string
                  description: Twilio Call SID
                SpeechResult:
                  type: string
                  description: Recognized speech text
                Confidence:
                  type: string
                  description: Speech recognition confidence score
      responses:
        '200':
          description: TwiML response for next step or call termination
          content:
            application/xml:
              schema:
                type: string
                description: TwiML XML
        '503':
          description: Voice features not available
    get:
      tags:
        - Voice
      summary: Twilio webhook - Speech capture (GET)
      description: Alternative GET handler for Twilio webhook
      operationId: voiceCaptureGet
      parameters:
        - name: step
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: TwiML response
          content:
            application/xml:
              schema:
                type: string
        '503':
          description: Voice features not available

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Supabase JWT token from authenticated user session.
        Get the token from `supabase.auth.getSession()` in the frontend.
        Include in header: `Authorization: Bearer <token>`

  schemas:
    Match:
      type: object
      description: Executive candidate match result
      properties:
        id:
          type: string
          description: Candidate ID
          example: "cand-001"
        name:
          type: string
          description: Full name of candidate
          example: "John Smith"
        role:
          type: string
          description: Role/title
          example: "CFO"
        summary:
          type: string
          description: Brief summary/bio
          example: "Experienced CFO with 15 years in Fintech"
        location:
          type: string
          description: Location preference
          example: "Ireland"
        industries:
          type: array
          items:
            type: string
          description: List of industries
          example: ["Fintech", "SaaS"]
        expertise:
          type: array
          items:
            type: string
          description: List of expertise areas
          example: ["CFO", "Finance"]
        availability:
          type: string
          description: Availability type
          enum: [fractional, full_time]
          example: "fractional"
        experience_years:
          type: integer
          description: Years of experience
          example: 15
        comp_expectation:
          type: integer
          description: Compensation expectation
          example: 120000
        highlights:
          type: array
          items:
            type: string
          description: Key achievements/highlights
          example: ["Led Series B fundraising", "Built finance team from scratch"]
        email:
          type: string
          format: email
          description: Contact email
          example: "john@example.com"

    ErrorResponse:
      type: object
      required:
        - ok
        - error
      properties:
        ok:
          type: boolean
          example: false
        error:
          type: string
          description: Error message
          example: "Missing required fields: email, name"

    MatchRequest:
      type: object
      description: |
        All fields are optional. The matching algorithm will score candidates based on provided criteria.
        If no criteria are provided, returns all available candidates.
      properties:
        industry:
          type: string
          description: Industry focus (e.g., Fintech, SaaS, Insurance)
          example: "Fintech"
        expertise:
          type: string
          description: Desired role/expertise (e.g., CFO, CEO, CTO)
          example: "CFO"
        availability:
          type: string
          description: Availability type (fractional or full_time)
          enum: [fractional, full_time]
          example: "fractional"
        min_experience:
          type: integer
          description: Minimum years of experience required
          minimum: 0
          example: 10
        max_salary:
          type: integer
          description: Maximum salary budget
          minimum: 0
          example: 150000
        location:
          type: string
          description: Location preference (e.g., Ireland, UK, Remote)
          example: "Ireland"

    RolePostingRequest:
      type: object
      required:
        - role_title
        - industry
        - role_description
        - experience_level
        - commitment
        - role_type
      properties:
        role_title:
          type: string
          example: "Chief Financial Officer"
        company_name:
          type: string
          nullable: true
          example: "Acme Corp"
        industry:
          type: string
          example: "Fintech"
        role_description:
          type: string
          example: "Leading financial strategy for Series B startup"
        experience_level:
          type: string
          example: "Senior"
        commitment:
          type: string
          description: Commitment type (fractional or full_time)
          enum: [fractional, full_time]
          example: "fractional"
        role_type:
          type: string
          description: Role type (CFO, CEO, CTO, etc.)
          example: "CFO"
        is_remote:
          type: boolean
          default: false
          example: true
        location:
          type: string
          nullable: true
          example: "Ireland"
        budget_range:
          type: string
          nullable: true
          example: "€100k-€150k"
        contact_name:
          type: string
          nullable: true
          example: "Jane Doe"
        contact_email:
          type: string
          nullable: true
          example: "jane@acme.com"
        phone:
          type: string
          nullable: true
          example: "+353123456789"
        linkedin:
          type: string
          nullable: true
          example: "https://linkedin.com/company/acme"
        website:
          type: string
          nullable: true
          example: "https://acme.com"
        company_mission:
          type: string
          nullable: true
          example: "Building the future of fintech"

    RolePosting:
      type: object
      properties:
        id:
          type: string
        role_title:
          type: string
        company_name:
          type: string
          nullable: true
        industry:
          type: string
        role_description:
          type: string
        experience_level:
          type: string
        commitment_type:
          type: string
        role_type:
          type: string
        is_remote:
          type: boolean
        location:
          type: string
          nullable: true
        compensation:
          type: string
          nullable: true
        contact_name:
          type: string
          nullable: true
        contact_email:
          type: string
          nullable: true
        phone:
          type: string
          nullable: true
        linkedin:
          type: string
          nullable: true
        website:
          type: string
          nullable: true
        company_mission:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    IntroRequest:
      type: object
      required:
        - user_type
        - requester_name
        - requester_email
        - match_id
      properties:
        user_type:
          type: string
          enum: [client, candidate]
          description: Type of user making the request
          example: "client"
        requester_name:
          type: string
          example: "Jane Doe"
        requester_email:
          type: string
          format: email
          example: "jane@acme.com"
        requester_company:
          type: string
          nullable: true
          example: "Acme Corp"
        match_id:
          type: string
          description: ID of the candidate/match (people_profiles.id or user_id)
          example: "cand-001"
        notes:
          type: string
          nullable: true
          description: Additional notes about the introduction
          example: "Series B GTM help needed"
        opportunity_id:
          type: string
          nullable: true
          description: Optional opportunity ID to link this introduction to
          example: "opp-123"

